<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Robert Panzers Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">
    <meta name="generator" content"JBake">

    <!-- Le styles -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/asciidoctor.css" rel="stylesheet">
    <link href="/css/base.css" rel="stylesheet">
    <link href="/css/bootstrap-responsive.min.css" rel="stylesheet">
    <link href="/css/disqus.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="/js/html5shiv.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="favicon.ico">

  </head>
  <body>
    <div id="wrap">
	
	<!-- Fixed navbar -->
      <div class="navbar navbar-fixed-top">
        <div class="navbar-inner">
          <div class="container">
            <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="brand" href="/">Robert Panzers blog</a>
            <div class="nav-collapse collapse">
              <ul class="nav">
                <li><a href="/index.html">Blog</a></li>
                <li><a href="/hubtogo/index.html">Hub to go</a></li>
                <li><a href="/about.html">About</a></li>
              </ul>
            </div><!--/.nav-collapse -->
          </div>
        </div>
      </div>
      <div class="container">

	<div class="page-header">
		<h1>Blog</h1>
	</div>
  			<a href="blog/2014/inboundra-threadpoolsize.html"><h1>Thread pool configuration for inbound resource adapters on TomEE</h1></a>
  			<p>05 Oktober 2014</p>
  			<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Developing resource adapters is surely one of the least known parts of the JavaEE platform.
Besides developing the component additional knowledge is required for operating the component.
Whereas for servlets most of the customization work for an operating environment is done by configuring the WebContainer thread pool size and the resource pool sizes, this is slightly more complex for resource adapters.
This article presents a demo application that allows to play around the properties that have to be taken care of.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_demo_application">The Demo application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The demo application is very simple.
You can try out this application yourself by cloning the repository <a href="https://github.com/robertpanzer/resource-adapter-configuration.git">robertpanzer/resource-adapter-configuration</a> from Github.</p>
</div>
<div class="paragraph">
<p>It consists solely of an inbound resource adapter that invokes MDBs implementing the listener interface <code>ITestListener</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public interface ITestListener {

    void process(int i);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>After activation of a MDB the resource adapter invokes the MDB 1000 times passing the number of iterations.
To invoke a MDB the resource adapter has to schedule a <code>Work</code> object via the so-called <code>WorkManager</code> so that the actions are executed by managed threads and do not take down the server.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public void endpointActivation(MessageEndpointFactory endpointFactory, ActivationSpec spec) throws ResourceException {
    WorkManager workManager = ctx.getWorkManager();

    for (int i = 0; i &lt; iterations; i++) {
        workManager.scheduleWork( <b class="conum">(1)</b>
            new TestWork(i, endpointFactory), <b class="conum">(2)</b>
            100, <b class="conum">(3)</b>
            null,
            null);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Every logic that invokes an application component has to be processed by a managed thread.
Therefore the work is scheduled via the <code>WorkManager</code></p>
</li>
<li>
<p>The work object requires the current iteration number to pass the correct argument to the listener and the endpoint factory to get a handle to the associated MDB.</p>
</li>
<li>
<p>The scheduled work should not start before 100 milliseconds have passed.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The WorkManager is offered by the application server and acts as an executor that uses an own thread pool.
The <code>Work</code> object comes from the concrete resource adapter and usually invokes an <code>Endpoint</code>, i.e. the MDB:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">class TestWork implements Work {

    private final int iteration; <b class="conum">(1)</b>
    private MessageEndpointFactory endpointFactory;

    TestWork(int iteration, MessageEndpointFactory endpointFactory) {
        this.iteration = iteration;
        this.endpointFactory = endpointFactory;
    }

    @Override
    public void release() {}

    @Override
    public void run() { <b class="conum">(2)</b>
        System.out.println("TestWork.run on thread " + Thread.currentThread());
        try {
            MessageEndpoint endpoint = endpointFactory.createEndpoint(null);
            endpoint.beforeDelivery(listenerMethod);
            listenerMethod.invoke(endpoint, iteration); <b class="conum">(3)</b>
            endpoint.afterDelivery();
            endpoint.release();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>There is one <code>Work</code> instance per iteration.
That is one <code>Work</code> object is used for one invocation of the MDB.</p>
</li>
<li>
<p>The <code>run()</code> method is already executed by the thread managed by the <code>WorkManager</code>.
The MDB is executed by the same thread.</p>
</li>
<li>
<p>This is the magic location that invokes the MDB represented by the <code>endpoint</code> passing the parameter <code>iteration</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In the demo application the MDB <code>TestMDB</code> does nothing more than counting the number of calls:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@MessageDriven
public class TestMDB implements ITestListener {

    public static AtomicInteger numberOfCalls = new AtomicInteger();

    @Override
    public void process(int i) {
        numberOfCalls.incrementAndGet();
        System.out.println("Iteration = " + i);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The demo application is executed as an <a href="https://arquillian.org">Arquillian</a> test.
This test waits at most 10 seconds until all expected calls of the MDB have been executed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">int expectedIterations = 1000;
await().untilAtomic(TestMDB.numberOfCalls, is(expectedIterations));</code></pre>
</div>
</div>
<div class="paragraph">
<p>This test can be executed by simply calling the <a href="http://gradle.org">Gradle</a> build:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>./gradlew clean test</pre>
</div>
</div>
<div class="paragraph">
<p>If you execute this you will likely see that this test fails!
But why?</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_thread_pools_vs_bean_pools">Thread pools vs Bean pools</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The test fails because not all MDB invocations pass successfully.
The expected number of calls is 1000 and on my local machine I see around 950 invocations.
So where do these calls get lost?
If you analyze the output of the test you see exceptions like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>javax.resource.spi.UnavailableException: Only 10 instances can be created
    at org.apache.openejb.core.mdb.MdbInstanceFactory.createInstance(MdbInstanceFactory.java:117)
    at org.apache.openejb.core.mdb.EndpointHandler.&lt;init&gt;(EndpointHandler.java:78)
    at org.apache.openejb.core.mdb.EndpointFactory.createEndpoint(EndpointFactory.java:78)
    at foo.bar.TestResourceAdapter$TestWork.run(TestResourceAdapter.java:110)
    at org.apache.geronimo.connector.work.WorkerContext.run(WorkerContext.java:366)
    at org.apache.geronimo.connector.work.pool.NamedRunnable.run(NamedRunnable.java:32)
    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
    at java.lang.Thread.run(Thread.java:745)</pre>
</div>
</div>
<div class="paragraph">
<p>Apparently someone tries to invoke the MDB even though the maximum number of beans is in use.
Obviously the default maximum number of beans is 10.</p>
</div>
<div class="paragraph">
<p>If you look at the top of the output you will see that the default thread pool size for a resource adapter is 30:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Okt 04, 2014 10:30:35 PM org.apache.openejb.assembler.classic.Assembler createResource
INFORMATION: Thread pool size for 'test.rarRA' is (30)</pre>
</div>
</div>
<div class="paragraph">
<p>And the Work objects are executed by this thread pool as you can see from the output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>foo.bar.RATest STANDARD_OUT
    TestWork.run on thread Thread[test.rarRA-worker- - 6,5,main]</pre>
</div>
</div>
<div class="paragraph">
<p>So here we have the conflict:
30 threads are firing invocations concurrently at only 10 bean instances.
And according to the specification the application server is allowed to refuse the call with an <code>UnavailableException</code>.
This default configuration can lead to errors if the resource adapter does not handle these exception by retrying the invocation.</p>
</div>
<div class="paragraph">
<p>At first thought this does not make any sense and makes you probably think why are these two pool sizes not identical?
But it makes sense if you have multiple MDBs that are activated for the same resource adapter:
If you have three MDBs that register for the same resource adapter the math works again as long as the calls are distributed equally across the MDBs.</p>
</div>
<div class="paragraph">
<p>So what seems to be necessary is the possibility to configure the MDB pool size to match the number of threads.
But from a performance point of view it is also necessary to configure the thread pool size:
According to the expected load and the behaviour of the application different thread pool sizes are required.
The next sections will show how to simply configure these values.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configure_the_thread_pool_size_of_a_resource_adapter">Configure the thread pool size of a resource adapter</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The log always shows the number of threads TomEE creates for the resource adapter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Okt 04, 2014 10:30:35 PM org.apache.openejb.assembler.classic.Assembler createResource
INFORMATION: Thread pool size for 'test.rarRA' is (30)</pre>
</div>
</div>
<div class="paragraph">
<p>From this entry you can take the information that the <em>ID</em> of the resource adapter is <code>test.rarRA</code>.
To change the thread pool size you only have to define the system property <code>test.rarRa.threadPoolSize</code> to the desired value.</p>
</div>
<div class="paragraph">
<p>So to make the test work you could for example reduce the thread pool size to 10 by setting the system property <code>-Dtest.rarRa.threadPoolSize=10</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configure_the_bean_pool_size_of_the_mdb">Configure the bean pool size of the MDB</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When you analyze the log you will find an entry that shows that the MDB is being started:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Okt 04, 2014 10:30:35 PM org.apache.openejb.assembler.classic.Assembler startEjbs
INFORMATION: Created Ejb(deployment-id=TestMDB, ejb-name=TestMDB, container=test.rar)
Okt 04, 2014 10:30:35 PM org.apache.openejb.assembler.classic.Assembler startEjbs
INFORMATION: Started Ejb(deployment-id=TestMDB, ejb-name=TestMDB, container=test.rar)</pre>
</div>
</div>
<div class="paragraph">
<p>So the <em>ID</em> of the MDB is <code>TestMDB</code> and you define the bean pool size by setting the system property <code>TestMDB.InstanceLimit</code> to the desired limit.</p>
</div>
<div class="paragraph">
<p>To make the test work without changing the thread pool size you could also increase the number of MDB instances to 30 by setting the system property <code>-DTestMDB.InstanceLimit=30</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_try_it_out">Try it out!</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To try these statements I built the <code>build.gradle</code> file so that you can pass these system properties as project properties to the build.
To test with a thread pool size of 20 and a bean pool size of 20 start the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>./gradlew clean test -Ptest.rarRA.threadPoolSize=20 -PTestMDB.InstanceLimit=20</pre>
</div>
</div>
<div class="paragraph">
<p>The test should succeed now!</p>
</div>
<div class="paragraph">
<p>You can play with different values to see how the behaviour changes.</p>
</div>
<div class="paragraph">
<p>If you want to define the system properties when starting a real TomEE you can for example simply set the environment variable <code>CATALINA_OPTS</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CATALINA_OPTS=-Dtest.rarRA.threadPoolSize=20 -DTestMDB.InstanceLimit=20</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_even_more_configuration">Even more configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Regarding the resource adapter you cannot only configure the thread pool size via system properties but you can configure other properties as well.
Just use the <em>ID</em> of the resource adapter as the prefix.
In the example the number of iterations can be configured via the property <code>iterations</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Connector
public class TestResourceAdapter implements ResourceAdapter {

    private int iterations = 1000;

    public int getIterations() {
        return iterations;
    }

    public void setIterations(int iterations) {
        System.out.println("iterations = " + iterations);
        this.iterations = iterations;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To change the number of iterations to 500 simply define the system property <code>test.rarRA.iterations</code> to 500:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>./gradlew clean test -Ptest.rarRA.iterations=500</pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CATALINA_OPTS=-Dtest.rarRA.iterations=500</pre>
</div>
</div>
</div>
</div></p>
  			<a href="blog/2014/outboundra-test-on-arquillian-tomee.html"><h1>Testing outbound resource adapters with Arquillian on an embedded TomEE</h1></a>
  			<p>14 April 2014</p>
  			<p><div class="paragraph">
<p>This post shows how to test custom resource adapters with own implementations for the connection factory, managed connection factory etc using Arquillian on TomEE embedded.</p>
</div>
<div class="paragraph">
<p>When developing a new custom resource adapter that have their own connections, managed connections, connection factories and managed connection factories you have a lot of code-compile-test loops because you have to do a lot of boiler plate code. The more often you repeat this the more likely you wish to accelerate this.</p>
</div>
<div class="paragraph">
<p>Arquillian comes to the rescue by automating deployment and test execution. The next idea to accelerate this is to use an embedded TomEE as the test container, which seems to be one of the fastest application servers.</p>
</div>
<div class="paragraph">
<p>While having many examples for how to define JDBC or JMS connection factories in the tomee.xml or in the arquillian.xml using system properties (<a href="http://svn.apache.org/repos/asf/tomee/tomee/tags/tomee-1.5.2/arquillian/arquillian-tomee-tests/arquillian-tomee-webprofile-tests/src/test/resources/arquillian.xml" class="bare">http://svn.apache.org/repos/asf/tomee/tomee/tags/tomee-1.5.2/arquillian/arquillian-tomee-tests/arquillian-tomee-webprofile-tests/src/test/resources/arquillian.xml</a>), I did not find a description of how to define a connection factory for my own custom outbound resource adapter.</p>
</div>
<div class="paragraph">
<p>Suppose that you have a managed connection factory like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">package foo.test;

import javax.resource.spi.ManagedConnection;
import javax.resource.spi.ManagedConnectionFactory;

@ConnectionDefinition(
        connection=IMyConnection.class,
        connectionImpl=MyConnectionImpl.class,
        connectionFactory=IMyConnectionFactory.class,
        connectionFactoryImpl=MyConnectionFactoryImpl.class)
public class MyManagedConnectionFactory implements ManagedConnectionFactory {
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You also need a ResourceAdapter bean, the methods can remain empty if you do not support inbound communication:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Connector(
        vendorName="FooBar",
        displayName="MyResourceAdapter",
        transactionSupport=TransactionSupportLevel.NoTransaction)
public class MyResourceAdapter implements ResourceAdapter {

    public void start(BootstrapContext ctx) throws ResourceAdapterInternalException {}

    public void stop() {}

    public void endpointActivation(MessageEndpointFactory endpointFactory,ActivationSpec spec) throws ResourceException {
        throw new UnsupportedOperationException();
    }

    public void endpointDeactivation(MessageEndpointFactory endpointFactory, ActivationSpec spec) {
        throw new UnsupportedOperationException();
    }

    public XAResource[] getXAResources(ActivationSpec[] specs) throws ResourceException {
        return null;
    }

    // equals and hashCode are required per the specification. As we do not have any properties
    // on the bean I don't know a better implementation than calling the super implementation.
    public boolean equals(Object o) {
        return super.equals(o);
    }

    public int hashCode() {
        return super.hashCode();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The goal is to get an IMyConnectionFactory injected into the test class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@RunWith(Arquillian.class)
public class JCATest {

	@Deployment
	public static EnterpriseArchive deploy() throws Exception {
	    JavaArchive rarlib = ShrinkWrap.create(JavaArchive.class, "rarlib.jar")
	        .addClasses(
	            IMyConnection.class,
	            MyConnectionImpl.class,
	            IMyConnectionFactory.class,
	            MyConnectionFactoryImpl.class,
	            MyManagedConnectionFactory.class,
	            ...);

	    ResourceAdapterArchive rar = ShrinkWrap.create(ResourceAdapterArchive.class, "testra.rar")
	        .addAsLibrary(rarlib);

	    JavaArchive testjar = ShrinkWrap.create(JavaArchive.class, "test.jar")
	        .addClasses(JCATest.class)
	        .addAsManifestResource(EmptyAsset.INSTANCE, "beans.xml");

	    EnterpriseArchive ear = ShrinkWrap.create(EnterpriseArchive.class, "test.ear")
	    	.addAsModule(rar)
            .addAsLibrary(testjar);

        return ear;
	}

	@Resource
	private IMyConnectionFactory connectionFactory;

	@Test
	public void test() {
	    ...
	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>On the first run the test will not start at all because the connection factory cannot be injected:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>org.apache.openejb.OpenEJBException: Can't find resource for class foo.test.JCATest#connectionFactory. (No provider available for resource-ref 'null' of type 'foo.test.IMyConnectionFactory' for 'ear-scoped-cdi-beans_ratest32.Comp1627526021'.)
	at org.apache.openejb.config.AutoConfig.processResourceRef(AutoConfig.java:1174)
	at org.apache.openejb.config.AutoConfig.deploy(AutoConfig.java:858)
	at org.apache.openejb.config.AutoConfig.deploy(AutoConfig.java:193)
	at org.apache.openejb.config.ConfigurationFactory$Chain.deploy(ConfigurationFactory.java:396)
	at org.apache.openejb.config.ConfigurationFactory.configureApplication(ConfigurationFactory.java:938)
	at org.apache.openejb.config.ConfigurationFactory.configureApplication(ConfigurationFactory.java:768)
	at org.apache.tomee.embedded.Container.deploy(Container.java:368)
	at org.apache.tomee.embedded.Container.deploy(Container.java:346)
	at org.apache.openejb.arquillian.embedded.EmbeddedTomEEContainer.deploy(EmbeddedTomEEContainer.java:134)
	at org.jboss.arquillian.container.impl.client.container.ContainerDeployController$3.call(ContainerDeployController.java:161)
	at org.jboss.arquillian.container.impl.client.container.ContainerDeployController$3.call(ContainerDeployController.java:128)
	at org.jboss.arquillian.container.impl.client.container.ContainerDeployController.executeOperation(ContainerDeployController.java:271)
	at org.jboss.arquillian.container.impl.client.container.ContainerDeployController.deploy(ContainerDeployController.java:127)</pre>
</div>
</div>
<div class="paragraph">
<p>If you were using a tomee.xml you would configure the connection factory like this. The trick is to define the managed connection factory class using the attribute class-name instead of using the attribute type that is used for known resource providers, like JDBC datasources etc.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;tomee&gt;
    &lt;Resource id="MyConnectionFactory"
       class-name="foo.test.MyManagedConnectionFactory"&gt;
    &lt;/Resource&gt;
&lt;/tomee&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you are testing using arquillian you can use the property definition style directly in the arquillian.xml.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;arquillian xmlns="http://jboss.org/schema/arquillian"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.jboss.org/schema/arquillian http://www.jboss.org/schema/arquillian/arquillian_1_0.xsd"&gt;

  &lt;container qualifier="tomee-embedded" default="true"&gt;
    &lt;configuration&gt;
      &lt;property name="httpPort"&gt;-1&lt;/property&gt;
      &lt;property name="stopPort"&gt;-1&lt;/property&gt;
      &lt;property name="dir"&gt;target/tomee-embedded&lt;/property&gt;
      &lt;property name="appWorkingDir"&gt;target/arquillian-embedded-working-dir&lt;/property&gt;
      &lt;property name="portRange"&gt;20001-30000&lt;/property&gt;
      &lt;property name="properties"&gt;
        MyConnectionFactory = new://Resource?class-name=foo.test.MyManagedConnectionFactory
      &lt;/property&gt;
    &lt;/configuration&gt;
  &lt;/container&gt;
&lt;/arquillian&gt;</code></pre>
</div>
</div></p>
  			<a href="blog/2014/inboundra-nointfmdbs.html"><h1> JavaEE 7 style inbound resource adapters on TomEE</h1></a>
  			<p>06 April 2014</p>
  			<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Java EE 7 brings some not so obvious additions. One of them is in particular interesting for resource adapter developers. This posting shows what this is about, how to run it on Wildfly and on TomEE, and how to test it.</p>
</div>
<div class="paragraph">
<p>Even though it seems that all new features of Java EE 7 are around HTML5 including WebSockets, ManagedExecutors and Batch there are also some other more subtle additions that are worth trying out. One very interesting point for developers of resource adapters that went into EJB 3.2 and JCA 1.7 is the addition of message driven beans with no-method listener interfaces. Thanks go to David Blevins of Tomitribe for pointing me on that. Instead of having predefined methods on an interface Java EE 7 allows to reflect the MDB class and therefore invoke any public method of that.</p>
</div>
<div class="paragraph">
<p>In this way an application is able to allow for developing MDBs that feel like JAX-RS endpoints. So you can check the methods of the MDB for annotations and dynamically dispatch an event of the connector. Here I present an example that you can also find on <a href="https://github.com/robertpanzer/filesystemwatch-connector" class="bare">https://github.com/robertpanzer/filesystemwatch-connector</a>. This resource adapter uses the Java SE 7 java.nio FileSystem WatchService to observe a directory for file changes. Whenever a file is created, deleted or modified in that directory the MDB should be called.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_code">The code</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s start with the API. The API for an inbound resource adapter is the listener interface. The user of that API is the MDB. To profit from this new programming model the listener interface has to be empty. So it simply looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public interface FSWatcher {}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The MDB should implement methods that declare the type of event and the type of files for which they should be called, so that we get from MDBs having methods like onCreate(File f) to something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@MessageDriven(activationConfig = {
	@ActivationConfigProperty(propertyName = "dir", propertyValue = ".") })
public class FSWatcherMDB implements FSWatcher {
	@Create(".*\\.txt")
	public void onNewTextFile(File f) {...}

	@Create(".*\\.pdf")
	public void onNewPdfFile(File f) {...}

	@Delete(".*\\.txt")
	public void onDeleteTextFile(File f) {...}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s pretty amazing, right? The MDB declares in its activationspec the directory it wants to watch. For every kind of event and file type it implements a method without having to dispatch itself. This code is very expressive and concise.</p>
</div>
<div class="paragraph">
<p>The last missing part now is the resource adapter. The interesting part is the method endpointActivation that is called to register the MDB to the resource adapter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">	@Override
	public void endpointActivation(MessageEndpointFactory endpointFactory, ActivationSpec activationSpec) throws ResourceException {
		FSWatcherActivationSpec fsWatcherAS = (FSWatcherActivationSpec) activationSpec;

		try {
			WatchKey watchKey =
			    fileSystem.getPath(
			        fsWatcherAS.getDir()).register(
			            watchService,
			            StandardWatchEventKinds.ENTRY_CREATE,
			            StandardWatchEventKinds.ENTRY_DELETE,
			            StandardWatchEventKinds.ENTRY_MODIFY);
			listeners.put(watchKey, endpointFactory);

			endpointFactoryToBeanClass.put(
					endpointFactory,
					endpointFactory.getEndpointClass()); <b class="conum">(1)</b>
		} catch (IOException e) {
			throw new ResourceException(e);
		}
	}
	public Class&lt;?&gt; getBeanClass(MessageEndpointFactory endpointFactory) {
		return endpointFactoryToBeanClass.get(endpointFactory);
	}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>endpointFactory.getEndpointClass() returns the pure Class of the MDB, not the version of the application server that decorates or subclasses the MDB.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Now when an event is fired by the watch service the resource adapter can check the MDBs methods and call them if the annotations match. All this is done on a separate thread spawned by the resource adapter that waits for events from the WatchService.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">	private void dispatchEvents(List&lt;WatchEvent&lt;?&gt;&gt; events, MessageEndpointFactory messageEndpointFactory) {
		for (WatchEvent&lt;?&gt; event: events) {
			Path path = (Path) event.context();

			try {
				MessageEndpoint endpoint = messageEndpointFactory.createEndpoint(null);
				Class&lt;?&gt; beanClass = resourceAdapter.getBeanClass(messageEndpointFactory);
				for (Method m: beanClass.getMethods()) {
					if (StandardWatchEventKinds.ENTRY_CREATE.equals(event.kind())
							&amp;&amp; m.isAnnotationPresent(Create.class)
							&amp;&amp; path.toString().matches(m.getAnnotation(Create.class).value())) {
						invoke(endpoint, m, path);
					} else if (StandardWatchEventKinds.ENTRY_DELETE.equals(event.kind())
							&amp;&amp; m.isAnnotationPresent(Delete.class)
							&amp;&amp; path.toString().matches(m.getAnnotation(Delete.class).value())) {
						invoke(endpoint, m, path);
					} else if (StandardWatchEventKinds.ENTRY_MODIFY.equals(event.kind())
							&amp;&amp; m.isAnnotationPresent(Modify.class)
							&amp;&amp; path.toString().matches(m.getAnnotation(Modify.class).value())) {
						invoke(endpoint, m, path);
					}
				}
			} catch (Exception e) {
				e.printStackTrace();
			}
		}
	}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Great stuff, isn&#8217;t it? As a resource adapter developer you are now able to deliver a much more comfortable and elegant programming model to your MDB developers.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_you_said_tomee_where_is_it">You said TomEE! Where is it?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>TomEE+ supports JCA resource adapters, even though it is declared as only being certified for the Java EE Web Profile. But it is the Java EE 6 Web Profile so you might think that this will not work. But in fact it does! With a small difference.</p>
</div>
<div class="paragraph">
<p>If the activation spec defines methods getBeanClass() and setBeanClass(Class&lt;?&gt; cls) TomEE will set the bean class on the activation spec. So instead of calling EndpointFactory.getBeanClass() you simply call FSWatcherActivationSpec.getBeanClass(), so that you can change the method endpointActivation from above like this and it will work on TomEE as well as on Wildlfy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">			endpointFactoryToBeanClass.put(
					endpointFactory,
					fsWatcherAS.getBeanClass() != null ? fsWatcherAS.getBeanClass() : endpointFactory.getEndpointClass());</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_show_me_that_it_works">Show me that it works</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Testing this is certainly done using the <a href="http://arquillian.org">Arquillian</a> framework. If you do not know that yet and you are a Java EE developer you should definitely try that out.</p>
</div>
<div class="paragraph">
<p>A first positive test should look like:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a file in the directory referred to by the activation spec</p>
</li>
<li>
<p>Check that the MDB was called with the right path</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The fact that the MDB is called asynchronously adds an additional difficulty to the test. The first na&iuml;ve approach would be to wait a certain amount of time and check if a method has been called on the MDB. But that will make your tests run very long even when everything is ok and the MDB is called immediately. Or your tests could become fragile if you wait for a too short amount of time.</p>
</div>
<div class="paragraph">
<p>Andrew Lee Rubinger and Aslak Knutsen propose an improved approach in their book "Continuous Enterprise Development in Java" using the class java.util.concurrent.CyclicBarrier added by Java SE 7. It implements a barrier that most of us probably know from the CS lectures in parallel programming. Together with CDI events this makes test pass immediately if everything works fine and make it only wait if there is a failure.</p>
</div>
<div class="paragraph">
<p>So the idea is that the MDB fires a CDI event if a method is called. This event is observed by test class that walks into the barrier. The test method is the second party going into the barrier.</p>
</div>
<div class="paragraph">
<p>The test MDB basically looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@MessageDriven(activationConfig = { @ActivationConfigProperty(propertyName = "dir", propertyValue = ".") })
public class FSWatcherMDB implements FSWatcher {

	@Inject
	private Event&lt;FileEvent&gt; fileEvent;

	@Create(".*\\.txt")
	public void onNewTextFile(File f) {
		fileEvent.fire(new FileEvent(FileEvent.CREATE, f));
	}
	...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The test class looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@RunWith(Arquillian.class)
public class ResourceAdapterTest {

	@Deployment
	public static EnterpriseArchive deploy() throws Exception {...}

	private static CyclicBarrier barrier; <b class="conum">(1)</b>

	private static File newFile;          <b class="conum">(1)</b>

	private static int mode;              <b class="conum">(1)</b>

	@Before
	public void init() throws Exception {
		newFile = null;
		mode = 0;
		barrier = new CyclicBarrier(2);  <b class="conum">(2)</b>
	}

	@Test
	public void testTxtFile() throws Exception {

		File tempFile = new File(".", "testFile.txt");
		assertTrue("Could not create temp file", tempFile.createNewFile());

		barrier.await(10, TimeUnit.SECONDS);

		assertEquals(tempFile.getName(), newFile.getName());
		assertEquals(FileEvent.CREATE, mode);
	}

	public void notifyFileEvent(@Observes FileEvent fileEvent) {
		mode = fileEvent.getMode();
		newFile = fileEvent.getFile();
		try {
			barrier.await();
		} catch (InterruptedException | BrokenBarrierException e) {
			e.printStackTrace();
		}
	}

}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>These members are static because the CDI event will be delivered to another instance of the test class created by the CDI runtime.</p>
</li>
<li>
<p>Declares a barrier for 2 parties, that means barrier.await() finished as soon as 2 threads call that method or the given timeout elapsed.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_i_want_to_try_that">I want to try that</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can find this example at <a href="https://github.com/robertpanzer/filesystemwatch-connector" class="bare">https://github.com/robertpanzer/filesystemwatch-connector</a>.</p>
</div>
</div>
</div></p>
	
	<hr />
	
	<p>Older posts are available in the <a href="/archive.html">archive</a>.</p>

		</div>
		<div id="push"></div>
    </div>

        

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="/js/jquery-1.9.1.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/run_prettify.js"></script>
    
    <div id="footer">
      <div class="container">
        <p class="muted credit">&copy; 2013 | Mixed with <a href="http://twitter.github.com/bootstrap/">Bootstrap v2.3.1</a> | Baked with <a href="http://jbake.org">JBake v2.3.2</a></p>
      </div>
    </div>
    

  </body>
</html>